<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:views="clr-namespace:POS_in_NET.Views"
             xmlns:controls="clr-namespace:POS_in_NET.Controls"
             x:Class="POS_in_NET.Pages.UserManagementPage"
             Title=""
             BackgroundColor="{StaticResource Background}">

    <Grid RowDefinitions="Auto,Auto,*">
        
        <!-- Top Bar -->
        <views:TopBar x:Name="TopBar" Grid.Row="0"/>
        
        <!-- Toast Notification Overlay -->
        <controls:ToastNotification x:Name="ToastNotification" 
                                   Grid.RowSpan="3"
                                   ZIndex="1000"
                                   InputTransparent="True"/>
        
        <!-- Modern Tab Bar -->
        <Frame Grid.Row="1" 
               BackgroundColor="White"
               Padding="0"
               CornerRadius="0"
               HasShadow="False"
               BorderColor="#E5E7EB">
            <ScrollView Orientation="Horizontal" HorizontalScrollBarVisibility="Never" Padding="20,16">
                <HorizontalStackLayout Spacing="8" HorizontalOptions="Center">
                    <!-- Business Info Tab -->
                    <Border x:Name="BusinessTabBorder"
                            BackgroundColor="White"
                            StrokeThickness="1"
                            Stroke="#E5E7EB"
                            Padding="24,12"
                            MinimumWidthRequest="140"
                            HeightRequest="48">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="12"/>
                        </Border.StrokeShape>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnBusinessTabClicked"/>
                        </Border.GestureRecognizers>
                        <Label Text="Business Info" 
                               TextColor="#6B7280"
                               FontSize="14"
                               FontAttributes="Bold"
                               VerticalOptions="Center"
                               HorizontalOptions="Center"/>
                    </Border>

                    <!-- User Tab (Active) -->
                    <Border x:Name="UserTabBorder"
                            BackgroundColor="#DCFCE7"
                            StrokeThickness="2"
                            Stroke="#10B981"
                            Padding="24,12"
                            MinimumWidthRequest="100"
                            HeightRequest="48">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="12"/>
                        </Border.StrokeShape>
                        <Border.Shadow>
                            <Shadow Brush="#10B981" Radius="8" Opacity="0.2" Offset="0,2"/>
                        </Border.Shadow>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnUserTabClicked"/>
                        </Border.GestureRecognizers>
                        <Label Text="User" 
                               TextColor="#10B981"
                               FontSize="14"
                               FontAttributes="Bold"
                               VerticalOptions="Center"
                               HorizontalOptions="Center"/>
                    </Border>

                    <!-- OrderWeb Connect Tab -->
                    <Border x:Name="CloudTabBorder"
                            BackgroundColor="White"
                            StrokeThickness="1"
                            Stroke="#E5E7EB"
                            Padding="24,12"
                            MinimumWidthRequest="160"
                            HeightRequest="48">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="12"/>
                        </Border.StrokeShape>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnCloudTabClicked"/>
                        </Border.GestureRecognizers>
                        <Label Text="OrderWeb Connect" 
                               TextColor="#6B7280"
                               FontSize="14"
                               FontAttributes="Bold"
                               VerticalOptions="Center"
                               HorizontalOptions="Center"/>
                    </Border>

                    <!-- Order Number Tab -->
                    <Border x:Name="OrderNumberTabBorder"
                            BackgroundColor="White"
                            StrokeThickness="1"
                            Stroke="#E5E7EB"
                            Padding="24,12"
                            MinimumWidthRequest="140"
                            HeightRequest="48">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="12"/>
                        </Border.StrokeShape>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnOrderNumberTabClicked"/>
                        </Border.GestureRecognizers>
                        <Label Text="Order Number" 
                               TextColor="#6B7280"
                               FontSize="14"
                               FontAttributes="Bold"
                               VerticalOptions="Center"
                               HorizontalOptions="Center"/>
                    </Border>

                    <!-- Postcode Lookup Tab -->
                    <Border x:Name="PostcodeTabBorder"
                            BackgroundColor="White"
                            StrokeThickness="1"
                            Stroke="#E5E7EB"
                            Padding="24,12"
                            MinimumWidthRequest="150"
                            HeightRequest="48">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="12"/>
                        </Border.StrokeShape>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnPostcodeTabClicked"/>
                        </Border.GestureRecognizers>
                        <Label Text="Postcode Lookup" 
                               TextColor="#6B7280"
                               FontSize="14"
                               FontAttributes="Bold"
                               VerticalOptions="Center"
                               HorizontalOptions="Center"/>
                    </Border>
                </HorizontalStackLayout>
            </ScrollView>
        </Frame>
        
        <!-- Main Content -->
        <ScrollView Grid.Row="2">
        <VerticalStackLayout Padding="40" Spacing="32" MaximumWidthRequest="1400" HorizontalOptions="Center">
            
            <!-- Header Section -->
            <VerticalStackLayout Spacing="12" Margin="0,8,0,0">
                <Label Text="User Management" 
                       FontSize="28" 
                       FontAttributes="Bold"
                       TextColor="#1F2937" 
                       HorizontalOptions="Start"/>
                <Label Text="Manage your team members and their access levels" 
                       FontSize="15" 
                       TextColor="#6B7280" 
                       HorizontalOptions="Start"/>
            </VerticalStackLayout>

            <!-- Create User Form - Modern Elegant Design -->
            <Border BackgroundColor="White"
                    StrokeThickness="1"
                    Stroke="#E5E7EB"
                    Padding="40,36"
                    StrokeShape="RoundRectangle 16">
                <Border.Shadow>
                    <Shadow Brush="Black" Offset="0,2" Radius="16" Opacity="0.06" />
                </Border.Shadow>
                <VerticalStackLayout Spacing="28">
                    
                    <Label Text="Add New User" 
                           FontSize="20" 
                           FontAttributes="Bold"
                           TextColor="#1F2937" />
                    
                    <!-- Input Fields in Row -->
                    <Grid ColumnDefinitions="*,*,*" ColumnSpacing="24">
                        
                        <!-- Name Field -->
                        <VerticalStackLayout Grid.Column="0" Spacing="10">
                            <Label Text="Full Name"
                                   FontSize="14"
                                   FontAttributes="Bold"
                                   TextColor="#374151" />
                            <Border BackgroundColor="#F9FAFB"
                                    Stroke="#D1D5DB"
                                    StrokeThickness="1"
                                    Padding="16,14"
                                    StrokeShape="RoundRectangle 10">
                                <Entry x:Name="NameEntry"
                                       Placeholder="Enter name"
                                       FontSize="15"
                                       BackgroundColor="Transparent"
                                       TextColor="#1F2937"
                                       PlaceholderColor="#9CA3AF" />
                            </Border>
                        </VerticalStackLayout>

                        <!-- User ID Field -->
                        <VerticalStackLayout Grid.Column="1" Spacing="10">
                            <Label Text="User ID"
                                   FontSize="14"
                                   FontAttributes="Bold"
                                   TextColor="#374151" />
                            <Border BackgroundColor="#F9FAFB"
                                    Stroke="#D1D5DB"
                                    StrokeThickness="1"
                                    Padding="16,14"
                                    StrokeShape="RoundRectangle 10">
                                <Entry x:Name="PINEntry"
                                       Placeholder="Enter user ID"
                                       FontSize="15"
                                       BackgroundColor="Transparent"
                                       TextColor="#1F2937"
                                       PlaceholderColor="#9CA3AF"
                                       Keyboard="Numeric"
                                       MaxLength="4"
                                       TextChanged="OnPINTextChanged" />
                            </Border>
                        </VerticalStackLayout>

                        <!-- User Role Field -->
                        <VerticalStackLayout Grid.Column="2" Spacing="10">
                            <Label Text="Role"
                                   FontSize="14"
                                   FontAttributes="Bold"
                                   TextColor="#374151" />
                            <Border BackgroundColor="#F9FAFB"
                                    Stroke="#D1D5DB"
                                    StrokeThickness="1"
                                    Padding="16,14"
                                    StrokeShape="RoundRectangle 10">
                                <Grid>
                                    <Button x:Name="RoleButton"
                                            Text="Select role"
                                            FontSize="15"
                                            BackgroundColor="Transparent"
                                            TextColor="#6B7280"
                                            BorderWidth="0"
                                            Padding="0"
                                            HeightRequest="32"
                                            HorizontalOptions="Fill"
                                            Clicked="OnRoleButtonClicked" />
                                    <Picker x:Name="RolePicker"
                                            Title="Select role"
                                            FontSize="15"
                                            BackgroundColor="Transparent"
                                            TextColor="#1F2937"
                                            TitleColor="#9CA3AF"
                                            IsVisible="False"
                                            HeightRequest="32" />
                                </Grid>
                            </Border>
                        </VerticalStackLayout>
                        
                    </Grid>

                    <!-- Create Button -->
                    <Button x:Name="CreateUserButton"
                            Text="Create User"
                            BackgroundColor="#10B981"
                            TextColor="White"
                            FontSize="16"
                            FontAttributes="Bold"
                            CornerRadius="10"
                            HeightRequest="52"
                            MaximumWidthRequest="220"
                            HorizontalOptions="End"
                            Clicked="OnCreateUserClicked">
                        <Button.Shadow>
                            <Shadow Brush="#10B981"
                                    Offset="0,3"
                                    Radius="10"
                                    Opacity="0.25" />
                        </Button.Shadow>
                    </Button>

                    <!-- Status Message -->
                    <Label x:Name="StatusLabel"
                           Text=""
                           FontSize="14"
                           HorizontalOptions="Center"
                           IsVisible="False" />
                           
                </VerticalStackLayout>
            </Border>

            <!-- Existing Users Section -->
            <VerticalStackLayout Spacing="20">
                <Label Text="Team Members" 
                       FontSize="20" 
                       FontAttributes="Bold"
                       TextColor="#1F2937" />
                
                <!-- Users List -->
                <ScrollView HeightRequest="400">
                    <VerticalStackLayout Spacing="16">
                        <CollectionView x:Name="UsersCollectionView" 
                                        BackgroundColor="Transparent"
                                        ItemSizingStrategy="MeasureAllItems">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Border BackgroundColor="White"
                                            Stroke="#E5E7EB"
                                            StrokeThickness="1"
                                            Padding="28,24"
                                            Margin="0,0,0,12"
                                            StrokeShape="RoundRectangle 12">
                                        <Border.Shadow>
                                            <Shadow Brush="Black" Offset="0,1" Radius="8" Opacity="0.04" />
                                        </Border.Shadow>
                                        <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="20">
                                            
                                            <!-- User Info -->
                                            <VerticalStackLayout Grid.Column="0" Spacing="6" VerticalOptions="Center">
                                                <Label Text="{Binding Name}" 
                                                       FontSize="17" 
                                                       FontAttributes="Bold"
                                                       TextColor="#1F2937" />
                                                <HorizontalStackLayout Spacing="12">
                                                    <Label Text="ID:" 
                                                           FontSize="14"
                                                           TextColor="#6B7280" />
                                                    <Label Text="{Binding Username}" 
                                                           FontSize="14"
                                                           FontAttributes="Bold"
                                                           TextColor="#374151"/>
                                                </HorizontalStackLayout>
                                            </VerticalStackLayout>
                                            
                                            <!-- Edit Button -->
                                            <Button Grid.Column="1"
                                                    Text="Edit"
                                                    FontSize="15"
                                                    BackgroundColor="#F3F4F6"
                                                    TextColor="#4B5563"
                                                    FontAttributes="Bold"
                                                    BorderWidth="0"
                                                    Padding="20,10"
                                                    CornerRadius="8"
                                                    HeightRequest="40"
                                                    VerticalOptions="Center"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=EditUserCommand}"
                                                    CommandParameter="{Binding .}" />
                                            
                                            <!-- Delete Button -->
                                            <Button Grid.Column="2"
                                                    Text="Delete"
                                                    FontSize="15"
                                                    BackgroundColor="#FEE2E2"
                                                    TextColor="#DC2626"
                                                    FontAttributes="Bold"
                                                    BorderWidth="0"
                                                    Padding="20,10"
                                                    CornerRadius="8"
                                                    HeightRequest="40"
                                                    VerticalOptions="Center"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=DeleteUserCommand}"
                                                    CommandParameter="{Binding .}" />
                                            
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                        
                        <!-- Empty State -->
                        <VerticalStackLayout x:Name="EmptyStateView" 
                                             Spacing="16" 
                                             HorizontalOptions="Center" 
                                             IsVisible="False" 
                                             Margin="0,60,0,0">
                            <Label Text="No users yet" 
                                   FontSize="18" 
                                   FontAttributes="Bold"
                                   TextColor="#6B7280"
                                   HorizontalOptions="Center"/>
                            <Label Text="Create your first user to get started" 
                                   FontSize="15" 
                                   TextColor="#9CA3AF"
                                   HorizontalOptions="Center"/>
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </ScrollView>
                
            </VerticalStackLayout>

            <!-- Order Number Settings Section -->
            <VerticalStackLayout x:Name="OrderNumberContent" IsVisible="False" Spacing="32">
                
                <!-- Header Section -->
                <VerticalStackLayout Spacing="12" Margin="0,8,0,0">
                    <Label Text="Order Number Settings" 
                           FontSize="28" 
                           FontAttributes="Bold"
                           TextColor="#1F2937" 
                           HorizontalOptions="Start"/>
                    <Label Text="Configure your order number format and prefix" 
                           FontSize="15" 
                           TextColor="#6B7280" 
                           HorizontalOptions="Start"/>
                </VerticalStackLayout>

                <!-- Current Settings Display -->
                <Border BackgroundColor="White"
                        StrokeThickness="1"
                        Stroke="#E5E7EB"
                        Padding="32,28"
                        StrokeShape="RoundRectangle 16">
                    <Border.Shadow>
                        <Shadow Brush="Black" Offset="0,2" Radius="16" Opacity="0.06" />
                    </Border.Shadow>
                    <VerticalStackLayout Spacing="24">
                        
                        <Label Text="Current Configuration" 
                               FontSize="18" 
                               FontAttributes="Bold"
                               TextColor="#1F2937" />
                        
                        <!-- Current Prefix -->
                        <Grid ColumnDefinitions="200,*" RowSpacing="16">
                            <Label Grid.Column="0" 
                                   Text="Current Prefix:" 
                                   FontSize="15"
                                   FontAttributes="Bold"
                                   TextColor="#374151"
                                   VerticalOptions="Center"/>
                            <Label Grid.Column="1" 
                                   x:Name="CurrentPrefixLabel"
                                   Text="AA" 
                                   FontSize="20"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource Primary}"
                                   VerticalOptions="Center"/>
                        </Grid>
                        
                        <!-- Today's Order Count -->
                        <Grid ColumnDefinitions="200,*">
                            <Label Grid.Column="0" 
                                   Text="Today's Orders:" 
                                   FontSize="15"
                                   FontAttributes="Bold"
                                   TextColor="#374151"
                                   VerticalOptions="Center"/>
                            <Label Grid.Column="1" 
                                   x:Name="TodayOrderCountLabel"
                                   Text="0" 
                                   FontSize="20"
                                   FontAttributes="Bold"
                                   TextColor="#10B981"
                                   VerticalOptions="Center"/>
                        </Grid>
                        
                        <!-- Order Format Example -->
                        <Border BackgroundColor="#F9FAFB"
                                Stroke="#E5E7EB"
                                StrokeThickness="1"
                                Padding="20"
                                StrokeShape="RoundRectangle 12">
                            <VerticalStackLayout Spacing="16">
                                <Label Text="Order Number Format:" 
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       TextColor="#6B7280"/>
                                <Label Text="[Prefix][Type][DDMMYY][Number]" 
                                       FontSize="15"
                                       FontFamily="Courier"
                                       TextColor="#1F2937"/>
                                <BoxView HeightRequest="1" BackgroundColor="#E5E7EB" Margin="0,8"/>
                                <Label Text="Example: AAC2712250" 
                                       FontSize="14"
                                       TextColor="#6B7280"/>
                                <Label Text="AA = Prefix, C = Collection, 271225 = Date, 0 = Order #" 
                                       FontSize="13"
                                       TextColor="#9CA3AF"/>
                            </VerticalStackLayout>
                        </Border>
                        
                        <!-- Next Order Numbers Preview -->
                        <VerticalStackLayout Spacing="12">
                            <Label Text="Next Order Numbers:" 
                                   FontSize="15"
                                   FontAttributes="Bold"
                                   TextColor="#374151"/>
                            
                            <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="8" ColumnSpacing="16">
                                <Label Grid.Row="0" Grid.Column="0" Text="Collection:" FontSize="14" TextColor="#6B7280"/>
                                <Label Grid.Row="0" Grid.Column="1" x:Name="NextCollectionLabel" Text="AAC2712250" FontSize="14" FontFamily="Courier" TextColor="#10B981" FontAttributes="Bold"/>
                                
                                <Label Grid.Row="1" Grid.Column="0" Text="Delivery:" FontSize="14" TextColor="#6B7280"/>
                                <Label Grid.Row="1" Grid.Column="1" x:Name="NextDeliveryLabel" Text="AAD2712250" FontSize="14" FontFamily="Courier" TextColor="#3B82F6" FontAttributes="Bold"/>
                                
                                <Label Grid.Row="2" Grid.Column="0" Text="Table:" FontSize="14" TextColor="#6B7280"/>
                                <Label Grid.Row="2" Grid.Column="1" x:Name="NextTableLabel" Text="AAT2712250" FontSize="14" FontFamily="Courier" TextColor="#F59E0B" FontAttributes="Bold"/>
                                
                                <Label Grid.Row="3" Grid.Column="0" Text="Web:" FontSize="14" TextColor="#6B7280"/>
                                <Label Grid.Row="3" Grid.Column="1" x:Name="NextWebLabel" Text="AAW2712250" FontSize="14" FontFamily="Courier" TextColor="#8B5CF6" FontAttributes="Bold"/>
                            </Grid>
                        </VerticalStackLayout>
                        
                    </VerticalStackLayout>
                </Border>

                <!-- Update Prefix Form -->
                <Border BackgroundColor="White"
                        StrokeThickness="1"
                        Stroke="#E5E7EB"
                        Padding="32,28"
                        StrokeShape="RoundRectangle 16">
                    <Border.Shadow>
                        <Shadow Brush="Black" Offset="0,2" Radius="16" Opacity="0.06" />
                    </Border.Shadow>
                    <VerticalStackLayout Spacing="24">
                        
                        <Label Text="Update Order Prefix" 
                               FontSize="18" 
                               FontAttributes="Bold"
                               TextColor="#1F2937" />
                        
                        <VerticalStackLayout Spacing="10" MaximumWidthRequest="400">
                            <Label Text="New Prefix (2 Letters)"
                                   FontSize="14"
                                   FontAttributes="Bold"
                                   TextColor="#374151" />
                            <Border BackgroundColor="#F9FAFB"
                                    Stroke="#D1D5DB"
                                    StrokeThickness="1"
                                    Padding="16,14"
                                    StrokeShape="RoundRectangle 10">
                                <Entry x:Name="PrefixEntry"
                                       Placeholder="AA"
                                       MaxLength="2"
                                       FontSize="18"
                                       FontAttributes="Bold"
                                       BackgroundColor="Transparent"
                                       TextColor="#1F2937"
                                       PlaceholderColor="#9CA3AF"
                                       HorizontalTextAlignment="Center" />
                            </Border>
                            <Label Text="Enter exactly 2 letters (A-Z)" 
                                   FontSize="12"
                                   TextColor="#9CA3AF"
                                   Margin="4,0,0,0"/>
                        </VerticalStackLayout>
                        
                        <Button Text="Update Prefix"
                                Clicked="OnUpdatePrefixClicked"
                                BackgroundColor="{StaticResource Primary}"
                                TextColor="White"
                                FontSize="16"
                                FontAttributes="Bold"
                                Padding="24,16"
                                CornerRadius="10"
                                HorizontalOptions="Start"
                                MinimumWidthRequest="200">
                            <Button.Shadow>
                                <Shadow Brush="{StaticResource Primary}" Offset="0,4" Radius="12" Opacity="0.3" />
                            </Button.Shadow>
                        </Button>
                        
                        <Border BackgroundColor="#FEF3C7"
                                Stroke="#F59E0B"
                                StrokeThickness="1"
                                Padding="16"
                                StrokeShape="RoundRectangle 8">
                            <Label TextColor="#92400E" FontSize="13" LineHeight="1.4">
                                <Label.FormattedText>
                                    <FormattedString>
                                        <Span Text="⚠️ Warning: " FontAttributes="Bold"/>
                                        <Span Text="Changing the prefix will affect all new orders immediately. The counter will continue from the current number for today."/>
                                    </FormattedString>
                                </Label.FormattedText>
                            </Label>
                        </Border>
                        
                    </VerticalStackLayout>
                </Border>
                
            </VerticalStackLayout>

            <!-- Loading Indicator -->
            <ActivityIndicator x:Name="LoadingIndicator" 
                               IsVisible="False" 
                               IsRunning="False" 
                               Color="{StaticResource Primary}"
                               HeightRequest="40"
                               WidthRequest="40"
                               HorizontalOptions="Center" />

        </VerticalStackLayout>
    </ScrollView>
    </Grid>
</ContentPage>