using POS_in_NET.Services;
using POS_in_NET.Models;

namespace POS_in_NET.Pages;

public partial class CloudSettingsPage : ContentPage
{
    private DatabaseService? _databaseService;
    private OrderWebWebSocketService? _webSocketService;
    private OrderWebRestApiService? _restApiService;
    private CloudConfiguration? _currentConfig;
    
    public CloudSettingsPage()
    {
        InitializeComponent();
    }
    
    protected override void OnAppearing()
    {
        base.OnAppearing();
        InitializeServices();
        _ = LoadSettingsAsync();
    }

    private void InitializeServices()
    {
        try
        {
            _databaseService = ServiceHelper.GetService<DatabaseService>();
            _webSocketService = ServiceHelper.GetService<OrderWebWebSocketService>();
            _restApiService = ServiceHelper.GetService<OrderWebRestApiService>();

            if (_webSocketService != null)
            {
                _webSocketService.NewOrderReceived += OnNewOrderReceived;
                _webSocketService.ConnectionStatusChanged += OnWebSocketStatusChanged;
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error initializing services: {ex.Message}");
        }
    }

    private async Task LoadSettingsAsync()
    {
        try
        {
            if (_databaseService == null)
            {
                System.Diagnostics.Debug.WriteLine("âš ï¸ DatabaseService not available");
                return;
            }

            StatusLabel.Text = "â³ Loading settings...";
            StatusLabel.TextColor = Color.FromArgb("#007BFF");

            _currentConfig = await _databaseService.GetCloudConfigurationAsync();

            if (_currentConfig != null)
            {
                // Update UI with loaded config
                RestApiBaseUrlEntry.Text = _currentConfig.RestApiBaseUrl;
                RestApiEndpointEntry.Text = _currentConfig.RestApiEndpoint;
                WebSocketUrlEntry.Text = _currentConfig.WebSocketUrl;
                TenantSlugEntry.Text = _currentConfig.TenantSlug;
                ApiKeyEntry.Text = _currentConfig.ApiKey;
                
                // Update previews
                UpdateUrlPreviews();
                
                ConnectionTimeoutEntry.Text = _currentConfig.ConnectionTimeout.ToString();
                MaxRetryAttemptsEntry.Text = _currentConfig.MaxRetryAttempts.ToString();
                AutoPrintCheckBox.IsChecked = _currentConfig.AutoPrintEnabled;
                NotificationsCheckBox.IsChecked = _currentConfig.NotificationsEnabled;

                // Enable test button if configured
                TestConnectionButton.IsEnabled = _currentConfig.IsConfigured();

                // Show test results if available
                if (_currentConfig.IsApiTested || _currentConfig.IsWebSocketTested)
                {
                    TestResultsFrame.IsVisible = true;
                    ApiTestResultLabel.Text = $"API: {_currentConfig.ApiTestResult ?? "Not tested"}";
                    WebSocketTestResultLabel.Text = $"WebSocket: {_currentConfig.WebSocketTestResult ?? "Not tested"}";
                }

                System.Diagnostics.Debug.WriteLine("âœ… Settings loaded successfully");
            }
            else
            {
                // Set defaults
                RestApiBaseUrlEntry.Text = "https://orderweb.net/api";
                WebSocketUrlEntry.Text = "wss://orderweb.net/ws/pos";
                ConnectionTimeoutEntry.Text = "30";
                MaxRetryAttemptsEntry.Text = "3";
                AutoPrintCheckBox.IsChecked = true;
                NotificationsCheckBox.IsChecked = true;
                
                UpdateUrlPreviews();
            }

            UpdateConnectionStatus();
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"âŒ Error loading settings: {ex.Message}");
            StatusLabel.Text = $"âš ï¸ Error loading settings: {ex.Message}";
            StatusLabel.TextColor = Color.FromArgb("#DC3545");
        }
    }
    
    private void OnWebSocketUrlChanged(object sender, TextChangedEventArgs e)
    {
        UpdateUrlPreviews();
    }
    
    private void UpdateUrlPreviews()
    {
        try
        {
            var restBase = RestApiBaseUrlEntry.Text?.Trim() ?? "https://orderweb.net/api";
            var restEndpoint = RestApiEndpointEntry.Text?.Trim() ?? "";
            var tenant = TenantSlugEntry.Text?.Trim() ?? "";
            var wsBase = WebSocketUrlEntry.Text?.Trim() ?? "wss://orderweb.net/ws/pos";
            
            // Update REST API URL preview
            if (!string.IsNullOrEmpty(restEndpoint))
            {
                FullRestApiUrlLabel.Text = $"Full URL: {restBase.TrimEnd('/')}/{restEndpoint.TrimStart('/')}";
            }
            else if (!string.IsNullOrEmpty(tenant))
            {
                FullRestApiUrlLabel.Text = $"Full URL: {restBase.TrimEnd('/')}/{tenant}";
            }
            else
            {
                FullRestApiUrlLabel.Text = $"Full URL: {restBase}";
            }
            
            // Update WebSocket URL preview
            if (!string.IsNullOrEmpty(tenant))
            {
                FullWebSocketUrlLabel.Text = $"Full URL: {wsBase.TrimEnd('/')}/{tenant}";
            }
            else
            {
                FullWebSocketUrlLabel.Text = $"Full URL: {wsBase}";
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error updating previews: {ex.Message}");
        }
    }

    private async void OnSaveSettingsClicked(object sender, EventArgs e)
    {
        try
        {
            StatusLabel.Text = "ðŸ’¾ Saving settings...";
            StatusLabel.TextColor = Color.FromArgb("#007BFF");

            // Validate inputs
            var tenantSlug = TenantSlugEntry.Text?.Trim() ?? "";
            var apiKey = ApiKeyEntry.Text?.Trim() ?? "";
            var restApiBase = RestApiBaseUrlEntry.Text?.Trim() ?? "https://orderweb.net/api";
            var restApiEndpoint = RestApiEndpointEntry.Text?.Trim() ?? "";
            var websocketUrl = WebSocketUrlEntry.Text?.Trim() ?? "wss://orderweb.net/ws/pos";

            if (string.IsNullOrEmpty(tenantSlug) || string.IsNullOrEmpty(apiKey))
            {
                StatusLabel.Text = "âŒ Please fill in Restaurant ID and API Key";
                StatusLabel.TextColor = Color.FromArgb("#DC3545");
                await ShowAlert("âš ï¸ Validation Error", "Restaurant ID and API Key are required", false);
                return;
            }

            // Parse advanced settings
            if (!int.TryParse(ConnectionTimeoutEntry.Text, out int timeout))
                timeout = 30;
            if (!int.TryParse(MaxRetryAttemptsEntry.Text, out int maxRetry))
                maxRetry = 3;

            // Create or update configuration
            var config = new CloudConfiguration
            {
                // Authentication
                TenantSlug = tenantSlug,
                ApiKey = apiKey,
                
                // REST API
                RestApiBaseUrl = restApiBase,
                RestApiEndpoint = restApiEndpoint,
                ApiBaseUrl = restApiBase, // Legacy field
                
                // WebSocket
                WebSocketUrl = websocketUrl,
                
                // Settings
                ConnectionTimeout = timeout,
                MaxRetryAttempts = maxRetry,
                AutoPrintEnabled = AutoPrintCheckBox.IsChecked,
                NotificationsEnabled = NotificationsCheckBox.IsChecked,
                PollingIntervalSeconds = 30,
                IsEnabled = false,
                IsApiTested = false,
                IsWebSocketTested = false
            };

            if (_databaseService == null)
            {
                await ShowAlert("âŒ Error", "Database service not available", false);
                return;
            }

            System.Diagnostics.Debug.WriteLine($"ðŸ’¾ Attempting to save configuration...");
            System.Diagnostics.Debug.WriteLine($"   Restaurant ID: {tenantSlug}");
            System.Diagnostics.Debug.WriteLine($"   REST API Base: {restApiBase}");
            System.Diagnostics.Debug.WriteLine($"   WebSocket: {websocketUrl}");

            var saved = await _databaseService.SaveCloudConfigurationAsync(config);

            if (saved)
            {
                _currentConfig = config;
                StatusLabel.Text = "âœ… Settings saved successfully!";
                StatusLabel.TextColor = Color.FromArgb("#28A745");
                TestConnectionButton.IsEnabled = true;
                TestResultsFrame.IsVisible = false;
                
                await ShowAlert("âœ… Success", 
                    $"Settings saved successfully!\n\n" +
                    $"REST API: {config.GetFullRestApiUrl()}\n" +
                    $"WebSocket: {config.GetWebSocketUrl()}\n\n" +
                    $"You can now test the connection.", true);
                
                System.Diagnostics.Debug.WriteLine($"âœ… Configuration saved successfully!");
            }
            else
            {
                StatusLabel.Text = "âŒ Failed to save settings";
                StatusLabel.TextColor = Color.FromArgb("#DC3545");
                await ShowAlert("âŒ Error", "Failed to save settings to database. Check debug console for details.", false);
                System.Diagnostics.Debug.WriteLine($"âŒ SaveCloudConfigurationAsync returned false");
            }

            UpdateConnectionStatus();
        }
        catch (Exception ex)
        {
            StatusLabel.Text = $"âŒ Error: {ex.Message}";
            StatusLabel.TextColor = Color.FromArgb("#DC3545");
            await ShowAlert("âŒ Error", $"Save failed: {ex.Message}", false);
            System.Diagnostics.Debug.WriteLine($"âŒ Save error: {ex}");
            System.Diagnostics.Debug.WriteLine($"âŒ Stack trace: {ex.StackTrace}");
        }
    }

    private async void OnTestConnectionClicked(object sender, EventArgs e)
    {
        try
        {
            StatusLabel.Text = "ðŸ” Testing connections...";
            StatusLabel.TextColor = Color.FromArgb("#007BFF");
            TestResultsFrame.IsVisible = true;
            ApiTestResultLabel.Text = "API: Testing...";
            WebSocketTestResultLabel.Text = "WebSocket: Testing...";

            if (_currentConfig == null || _databaseService == null)
            {
                await ShowAlert("âŒ Error", "Please save settings first", false);
                return;
            }

            bool apiSuccess = false;
            string apiMessage = "Not tested";
            bool wsSuccess = false;
            string wsMessage = "Not tested";

            // Test REST API
            if (_restApiService != null)
            {
                _restApiService.Configure(_currentConfig.ApiBaseUrl, _currentConfig.TenantSlug, _currentConfig.ApiKey);
                (apiSuccess, apiMessage) = await _restApiService.TestConnectionAsync();
                ApiTestResultLabel.Text = apiSuccess ? $"âœ… API: {apiMessage}" : $"âŒ API: {apiMessage}";
                ApiTestResultLabel.TextColor = apiSuccess ? Color.FromArgb("#28A745") : Color.FromArgb("#DC3545");
            }

            // Test WebSocket
            if (_webSocketService != null)
            {
                var wsUrl = string.IsNullOrEmpty(_currentConfig.WebSocketUrl) 
                    ? _currentConfig.GetWebSocketUrl() 
                    : _currentConfig.WebSocketUrl;
                
                _webSocketService.Configure(wsUrl, _currentConfig.TenantSlug, _currentConfig.ApiKey);
                
                try
                {
                    wsSuccess = await _webSocketService.TestConnectionAsync();
                    wsMessage = wsSuccess ? "Connected successfully" : "Connection failed";
                }
                catch (Exception wsEx)
                {
                    wsSuccess = false;
                    wsMessage = wsEx.Message;
                }

                WebSocketTestResultLabel.Text = wsSuccess ? $"âœ… WebSocket: {wsMessage}" : $"âŒ WebSocket: {wsMessage}";
                WebSocketTestResultLabel.TextColor = wsSuccess ? Color.FromArgb("#28A745") : Color.FromArgb("#DC3545");
            }

            // Save test results
            await _databaseService.UpdateConnectionTestResultsAsync(
                apiSuccess, apiMessage, wsSuccess, wsMessage);

            // Update current config
            _currentConfig.IsApiTested = apiSuccess;
            _currentConfig.IsWebSocketTested = wsSuccess;
            _currentConfig.ApiTestResult = apiMessage;
            _currentConfig.WebSocketTestResult = wsMessage;

            // Update status
            if (apiSuccess && wsSuccess)
            {
                StatusLabel.Text = "âœ… All connections tested successfully!";
                StatusLabel.TextColor = Color.FromArgb("#28A745");
                await ShowAlert("âœ… Success", "Both API and WebSocket connections are working! You can now start live orders.", true);
            }
            else if (apiSuccess || wsSuccess)
            {
                StatusLabel.Text = "âš ï¸ Partial success - Check test results";
                StatusLabel.TextColor = Color.FromArgb("#FFC107");
                await ShowAlert("âš ï¸ Partial Success", "Some connections failed. Check the test results.", false);
            }
            else
            {
                StatusLabel.Text = "âŒ Connection tests failed";
                StatusLabel.TextColor = Color.FromArgb("#DC3545");
                await ShowAlert("âŒ Failed", "Connection tests failed. Please check your settings.", false);
            }

            UpdateConnectionStatus();
        }
        catch (Exception ex)
        {
            StatusLabel.Text = $"âŒ Error: {ex.Message}";
            StatusLabel.TextColor = Color.FromArgb("#DC3545");
            await ShowAlert("âŒ Error", ex.Message, false);
            System.Diagnostics.Debug.WriteLine($"âŒ Test error: {ex}");
        }
    }

    private async void OnStartLiveOrdersClicked(object sender, EventArgs e)
    {
        try
        {
            if (_currentConfig == null || !_currentConfig.IsConfigured())
            {
                await ShowAlert("âš ï¸ Not Configured", "Please save and test your settings first", false);
                return;
            }

            if (!_currentConfig.IsFullyTested())
            {
                var result = await DisplayAlert("âš ï¸ Not Tested", 
                    "Connections haven't been tested yet. Start anyway?", 
                    "Yes, Start", "No, Cancel");
                if (!result) return;
            }

            StatusLabel.Text = "ðŸš€ Starting live orders...";
            StatusLabel.TextColor = Color.FromArgb("#007BFF");

            if (_webSocketService == null || _databaseService == null)
            {
                StatusLabel.Text = "âŒ Services not available";
                StatusLabel.TextColor = Color.FromArgb("#DC3545");
                await ShowAlert("âŒ Error", "Required services not available", false);
                return;
            }

            // Configure and start WebSocket
            var wsUrl = string.IsNullOrEmpty(_currentConfig.WebSocketUrl) 
                ? _currentConfig.GetWebSocketUrl() 
                : _currentConfig.WebSocketUrl;
            
            _webSocketService.Configure(wsUrl, _currentConfig.TenantSlug, _currentConfig.ApiKey);
            var wsSuccess = await _webSocketService.ConnectAsync();

            if (wsSuccess)
            {
                // Update config to enabled
                _currentConfig.IsEnabled = true;
                await _databaseService.SaveCloudConfigurationAsync(_currentConfig);

                StatusLabel.Text = "ðŸŽ‰ LIVE! Orders will appear instantly!";
                StatusLabel.TextColor = Color.FromArgb("#28A745");
                await ShowAlert("ðŸŽ‰ Success", "Live orders are now active! You'll receive real-time notifications for new orders.", true);

                System.Diagnostics.Debug.WriteLine("ðŸš€ OrderWeb.net integration fully active!");
            }
            else
            {
                StatusLabel.Text = "âŒ Failed to start live orders";
                StatusLabel.TextColor = Color.FromArgb("#DC3545");
                await ShowAlert("âŒ Failed", "Could not establish WebSocket connection", false);
            }

            UpdateConnectionStatus();
        }
        catch (Exception ex)
        {
            StatusLabel.Text = $"âŒ Error: {ex.Message}";
            StatusLabel.TextColor = Color.FromArgb("#DC3545");
            await ShowAlert("âŒ Error", ex.Message, false);
            System.Diagnostics.Debug.WriteLine($"âŒ Start live orders error: {ex}");
        }
    }

    private void OnNewOrderReceived(object? sender, OrderReceivedEventArgs e)
    {
        MainThread.BeginInvokeOnMainThread(async () =>
        {
            System.Diagnostics.Debug.WriteLine($"ðŸŽ‰ NEW ORDER: {e.OrderId}");
            
            if (_currentConfig?.NotificationsEnabled == true)
            {
                await ShowAlert("ðŸŽ‰ New Order!", 
                    $"From: {e.CustomerName}\nTotal: ${e.TotalAmount:F2}", 
                    true);
            }
        });
    }

    private void OnWebSocketStatusChanged(object? sender, ConnectionStatusEventArgs e)
    {
        MainThread.BeginInvokeOnMainThread(() =>
        {
            System.Diagnostics.Debug.WriteLine($"ðŸ”Œ WebSocket: {e.Message}");
            UpdateConnectionStatus();
        });
    }

    private void UpdateConnectionStatus()
    {
        try
        {
            if (_currentConfig == null)
            {
                StatusLabel.Text = "ðŸ”´ Not configured";
                StatusLabel.TextColor = Color.FromArgb("#DC3545");
                return;
            }

            if (_currentConfig.IsEnabled && _webSocketService?.IsConnected == true)
            {
                StatusLabel.Text = "ðŸŸ¢ LIVE - Real-time orders active";
                StatusLabel.TextColor = Color.FromArgb("#28A745");
            }
            else if (_currentConfig.IsFullyTested())
            {
                StatusLabel.Text = "ï¿½ Tested & Ready - Click 'Start Live Orders'";
                StatusLabel.TextColor = Color.FromArgb("#28A745");
            }
            else if (_currentConfig.IsConfigured())
            {
                StatusLabel.Text = "ï¿½ Configured - Test connection to continue";
                StatusLabel.TextColor = Color.FromArgb("#FFC107");
            }
            else
            {
                StatusLabel.Text = "ðŸ”´ Not configured";
                StatusLabel.TextColor = Color.FromArgb("#DC3545");
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error updating status: {ex.Message}");
        }
    }

    private async Task ShowAlert(string title, string message, bool isSuccess)
    {
        try
        {
            await MainThread.InvokeOnMainThreadAsync(async () =>
            {
                await DisplayAlert(title, message, "OK");
            });
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Alert error: {ex.Message}");
        }
    }
    
    private void OnRestApiBaseUrlChanged(object sender, TextChangedEventArgs e)
    {
        UpdateUrlPreviews();
    }
    
    private void OnRestApiEndpointChanged(object sender, TextChangedEventArgs e)
    {
        UpdateUrlPreviews();
    }
}

public static class ServiceHelper
{
    public static T? GetService<T>() where T : class
    {
        try
        {
            var current = Application.Current?.Handler?.MauiContext?.Services;
            if (current == null)
                return null;
                
            return current.GetService(typeof(T)) as T;
        }
        catch
        {
            return null;
        }
    }
}
