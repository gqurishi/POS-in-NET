using Microsoft.Maui.Controls;
using Microsoft.Maui.Controls.Shapes;
using MyFirstMauiApp.Models.FoodMenu;
using MyFirstMauiApp.Services;
using POS_in_NET.Models;
using POS_in_NET.Services;
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using System.Threading.Tasks;

namespace POS_in_NET.Pages
{
    public partial class OrderPlacementPage : ContentPage
    {
        private readonly MenuItemService _menuItemService;
        private readonly MenuCategoryService _categoryService;
        
        private TableOrder _currentOrder;
        private List<MenuCategory> _allCategories = new();
        private List<MenuCategory> _topLevelCategories = new();
        private List<FoodMenuItem> _allMenuItems = new();
        private List<FoodMenuItem> _filteredItems = new();
        
        private MenuCategory? _selectedCategory;
        private MenuCategory? _selectedSubCategory;
        private FoodMenuItem? _modifierPopupItem;
        
        private System.Timers.Timer? _timer;
        
        // Current logged in user
        private User? _currentUser;
        
        public OrderPlacementPage()
        {
            InitializeComponent();
            
            _menuItemService = new MenuItemService();
            _categoryService = new MenuCategoryService();
            
            // Initialize with default order
            InitializeOrder(5, 3, "Sarah", 1);
        }
        
        public OrderPlacementPage(string tableNumber, int coverCount, string staffName = "Staff", int staffId = 1)
        {
            InitializeComponent();
            
            _menuItemService = new MenuItemService();
            _categoryService = new MenuCategoryService();
            
            // Convert table number to int, default to 0 if conversion fails
            int tableNum = int.TryParse(tableNumber, out int num) ? num : 0;
            
            // Initialize with provided parameters
            InitializeOrder(tableNum, coverCount, staffName, staffId);
        }
        
        private void InitializeOrder(int tableNumber, int coverCount, string staffName, int staffId)
        {
            _currentOrder = new TableOrder
            {
                Id = Guid.NewGuid().ToString(),
                TableNumber = tableNumber,
                CoverCount = coverCount,
                StartTime = DateTime.Now,
                CreatedAt = DateTime.Now,
                UpdatedAt = DateTime.Now,
                StaffId = staffId,
                StaffName = staffName,
                ServiceChargePercent = 10
            };
            
            // Start timer
            StartTimer();
        }
        
        protected override async void OnAppearing()
        {
            base.OnAppearing();
            
            try
            {
                // Show loading indicator
                LoadingOverlay.IsVisible = true;
                await Task.Delay(100); // Allow UI to update
                
                await LoadDataAsync();
                UpdateDisplay();
                
                LoadingOverlay.IsVisible = false;
            }
            catch (Exception ex)
            {
                LoadingOverlay.IsVisible = false;
                await DisplayAlert("Error", $"Failed to initialize page: {ex.Message}\n\nStack: {ex.StackTrace}", "OK");
            }
        }
        
        protected override void OnDisappearing()
        {
            base.OnDisappearing();
            StopTimer();
        }
        
        private void StartTimer()
        {
            _timer = new System.Timers.Timer(1000); // Update every second
            _timer.Elapsed += (s, e) =>
            {
                MainThread.BeginInvokeOnMainThread(() =>
                {
                    UpdateTimer();
                });
            };
            _timer.Start();
        }
        
        private void StopTimer()
        {
            _timer?.Stop();
            _timer?.Dispose();
            _timer = null;
        }
        
        private void UpdateTimer()
        {
            TimerLabel.Text = $"â± {_currentOrder.ElapsedTimeDisplay}";
        }
        
        private async Task LoadDataAsync()
        {
            try
            {
                System.Diagnostics.Debug.WriteLine("[OrderPlacement] Starting to load data...");
                
                // Load categories
                _allCategories = await _categoryService.GetAllCategoriesAsync();
                System.Diagnostics.Debug.WriteLine($"[OrderPlacement] Loaded {_allCategories.Count} total categories");
                
                _topLevelCategories = _allCategories.Where(c => c.ParentId == null).OrderBy(c => c.DisplayOrder).ToList();
                System.Diagnostics.Debug.WriteLine($"[OrderPlacement] Found {_topLevelCategories.Count} top-level categories");
                
                // Load menu items
                _allMenuItems = await _menuItemService.GetAllItemsAsync();
                System.Diagnostics.Debug.WriteLine($"[OrderPlacement] Loaded {_allMenuItems.Count} menu items");
                
                // Build category buttons
                BuildCategoryButtons();
                
                // Select first category by default
                if (_topLevelCategories.Any())
                {
                    System.Diagnostics.Debug.WriteLine($"[OrderPlacement] Selecting first category: {_topLevelCategories.First().Name}");
                    SelectCategory(_topLevelCategories.First());
                }
                else
                {
                    System.Diagnostics.Debug.WriteLine("[OrderPlacement] WARNING: No top-level categories found!");
                    await DisplayAlert("No Data", "No menu categories found. Please add categories in Food Menu Management.", "OK");
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"[OrderPlacement] ERROR: {ex.Message}");
                System.Diagnostics.Debug.WriteLine($"[OrderPlacement] Stack: {ex.StackTrace}");
                await DisplayAlert("Error", $"Failed to load data: {ex.Message}\n\nDetails: {ex.InnerException?.Message}", "OK");
            }
        }
        
        private void BuildCategoryButtons()
        {
            CategoryRow1.Children.Clear();
            CategoryRow2.Children.Clear();
            
            int count = 0;
            foreach (var category in _topLevelCategories)
            {
                var button = CreateCategoryButton(category);
                
                if (count < 6)
                    CategoryRow1.Children.Add(button);
                else if (count < 12)
                    CategoryRow2.Children.Add(button);
                
                count++;
            }
        }
        
        private Button CreateCategoryButton(MenuCategory category)
        {
            var button = new Button
            {
                Text = category.Name,
                BackgroundColor = Color.FromArgb(category.Color),
                TextColor = Colors.White,
                FontSize = 14,
                FontAttributes = FontAttributes.Bold,
                CornerRadius = 8,
                Padding = new Thickness(15, 10),
                Margin = new Thickness(0, 0, 8, 0),
                WidthRequest = 120,
                HeightRequest = 50
            };
            
            button.Clicked += (s, e) => SelectCategory(category);
            return button;
        }
        
        private void SelectCategory(MenuCategory category)
        {
            _selectedCategory = category;
            _selectedSubCategory = null;
            
            // Load sub-categories
            var subCategories = _allCategories
                .Where(c => c.ParentId == category.Id)
                .OrderBy(c => c.DisplayOrder)
                .ToList();
            
            if (subCategories.Any())
            {
                BuildSubCategoryButtons(subCategories);
                SubCategorySection.IsVisible = true;
                
                // Auto-select first sub-category
                SelectSubCategory(subCategories.First());
            }
            else
            {
                SubCategorySection.IsVisible = false;
                LoadItemsForCategory(category.Id);
            }
        }
        
        private void BuildSubCategoryButtons(List<MenuCategory> subCategories)
        {
            SubCategoryRow1.Children.Clear();
            SubCategoryRow2.Children.Clear();
            
            int count = 0;
            foreach (var subCategory in subCategories)
            {
                var button = CreateSubCategoryButton(subCategory);
                
                if (count < 6)
                    SubCategoryRow1.Children.Add(button);
                else if (count < 12)
                    SubCategoryRow2.Children.Add(button);
                
                count++;
            }
        }
        
        private Button CreateSubCategoryButton(MenuCategory subCategory)
        {
            var lightColor = LightenColor(_selectedCategory?.Color ?? "#3B82F6");
            
            var button = new Button
            {
                Text = subCategory.Name,
                BackgroundColor = Color.FromArgb(lightColor),
                TextColor = Color.FromArgb("#1E293B"),
                FontSize = 13,
                FontAttributes = FontAttributes.Bold,
                CornerRadius = 8,
                Padding = new Thickness(12, 8),
                Margin = new Thickness(0, 0, 8, 0),
                WidthRequest = 120,
                HeightRequest = 45
            };
            
            button.Clicked += (s, e) => SelectSubCategory(subCategory);
            return button;
        }
        
        private void SelectSubCategory(MenuCategory subCategory)
        {
            _selectedSubCategory = subCategory;
            LoadItemsForCategory(subCategory.Id);
        }
        
        private void LoadItemsForCategory(string categoryId)
        {
            _filteredItems = _allMenuItems.Where(i => i.CategoryId == categoryId).OrderBy(i => i.DisplayOrder).ToList();
            BuildItemGrid();
        }
        
        private void BuildItemGrid()
        {
            ItemsGrid.Children.Clear();
            
            foreach (var item in _filteredItems)
            {
                var itemCard = CreateItemCard(item);
                ItemsGrid.Children.Add(itemCard);
            }
        }
        
        private Border CreateItemCard(FoodMenuItem item)
        {
            var categoryColor = _selectedCategory?.Color ?? "#3B82F6";
            
            var border = new Border
            {
                BackgroundColor = Colors.White,
                Stroke = Color.FromArgb("#E2E8F0"),
                StrokeThickness = 1,
                Padding = new Thickness(0),
                Margin = new Thickness(0, 0, 10, 10),
                WidthRequest = 140,
                HeightRequest = 100,
                StrokeShape = new RoundRectangle { CornerRadius = 10 }
            };
            
            var grid = new Grid
            {
                ColumnDefinitions =
                {
                    new ColumnDefinition { Width = new GridLength(4) },
                    new ColumnDefinition { Width = GridLength.Star }
                },
                RowDefinitions =
                {
                    new RowDefinition { Height = GridLength.Star },
                    new RowDefinition { Height = GridLength.Auto }
                }
            };
            
            // Color strip
            var colorStrip = new BoxView
            {
                BackgroundColor = Color.FromArgb(categoryColor)
            };
            Grid.SetColumn(colorStrip, 0);
            Grid.SetRowSpan(colorStrip, 2);
            grid.Children.Add(colorStrip);
            
            // Item name
            var nameLabel = new Label
            {
                Text = item.Name,
                FontSize = 13,
                FontAttributes = FontAttributes.Bold,
                TextColor = Color.FromArgb("#1E293B"),
                Margin = new Thickness(8, 8, 8, 4),
                LineBreakMode = LineBreakMode.WordWrap,
                MaxLines = 2
            };
            Grid.SetColumn(nameLabel, 1);
            Grid.SetRow(nameLabel, 0);
            grid.Children.Add(nameLabel);
            
            // Price
            var priceLabel = new Label
            {
                Text = $"Â£{item.Price:F2}",
                FontSize = 16,
                FontAttributes = FontAttributes.Bold,
                TextColor = Color.FromArgb("#10B981"),
                Margin = new Thickness(8, 0, 8, 8),
                VerticalOptions = LayoutOptions.End
            };
            Grid.SetColumn(priceLabel, 1);
            Grid.SetRow(priceLabel, 1);
            grid.Children.Add(priceLabel);
            
            border.Content = grid;
            
            // Add tap gesture
            var tapGesture = new TapGestureRecognizer();
            tapGesture.Tapped += (s, e) => OnItemTapped(item);
            border.GestureRecognizers.Add(tapGesture);
            
            return border;
        }
        
        private void OnItemTapped(FoodMenuItem item)
        {
            // Check if item has addons/modifiers
            if (item.HasAddons || !string.IsNullOrEmpty(item.Description))
            {
                ShowModifierPopup(item);
            }
            else
            {
                // Add directly to order
                AddItemToOrder(item, 1, null, null);
            }
        }
        
        private void ShowModifierPopup(FoodMenuItem item)
        {
            _modifierPopupItem = item;
            
            ModifierItemName.Text = item.Name;
            ModifierItemBasePrice.Text = $"Base: Â£{item.Price:F2}";
            ModifierContent.Children.Clear();
            
            // Quantity selector
            var quantitySection = CreateQuantitySelector();
            ModifierContent.Children.Add(quantitySection);
            
            // Addons section (if any)
            if (item.HasAddons)
            {
                var addonsSection = CreateAddonsSection(item.Addons);
                ModifierContent.Children.Add(addonsSection);
            }
            
            // Notes section
            var notesSection = CreateNotesSection();
            ModifierContent.Children.Add(notesSection);
            
            UpdateModifierTotal();
            
            ModifierPopupOverlay.IsVisible = true;
        }
        
        private VerticalStackLayout CreateQuantitySelector()
        {
            var section = new VerticalStackLayout { Spacing = 10 };
            
            var label = new Label
            {
                Text = "QUANTITY",
                FontSize = 14,
                FontAttributes = FontAttributes.Bold,
                TextColor = Color.FromArgb("#64748B")
            };
            section.Children.Add(label);
            
            var grid = new Grid
            {
                ColumnDefinitions =
                {
                    new ColumnDefinition { Width = new GridLength(50) },
                    new ColumnDefinition { Width = new GridLength(80) },
                    new ColumnDefinition { Width = new GridLength(50) }
                },
                ColumnSpacing = 10
            };
            
            var minusButton = new Button
            {
                Text = "âˆ’",
                BackgroundColor = Color.FromArgb("#EF4444"),
                TextColor = Colors.White,
                FontSize = 20,
                CornerRadius = 8,
                ClassId = "QuantityMinus"
            };
            minusButton.Clicked += OnQuantityChanged;
            Grid.SetColumn(minusButton, 0);
            grid.Children.Add(minusButton);
            
            var quantityLabel = new Label
            {
                Text = "1",
                FontSize = 20,
                FontAttributes = FontAttributes.Bold,
                TextColor = Color.FromArgb("#1E293B"),
                HorizontalTextAlignment = TextAlignment.Center,
                VerticalTextAlignment = TextAlignment.Center,
                ClassId = "QuantityLabel"
            };
            Grid.SetColumn(quantityLabel, 1);
            grid.Children.Add(quantityLabel);
            
            var plusButton = new Button
            {
                Text = "+",
                BackgroundColor = Color.FromArgb("#10B981"),
                TextColor = Colors.White,
                FontSize = 20,
                CornerRadius = 8,
                ClassId = "QuantityPlus"
            };
            plusButton.Clicked += OnQuantityChanged;
            Grid.SetColumn(plusButton, 2);
            grid.Children.Add(plusButton);
            
            section.Children.Add(grid);
            return section;
        }
        
        private VerticalStackLayout CreateAddonsSection(List<Addon> addons)
        {
            var section = new VerticalStackLayout { Spacing = 10 };
            
            var label = new Label
            {
                Text = "EXTRAS (Select multiple)",
                FontSize = 14,
                FontAttributes = FontAttributes.Bold,
                TextColor = Color.FromArgb("#64748B")
            };
            section.Children.Add(label);
            
            foreach (var addon in addons.Where(a => a.Available))
            {
                var checkBox = new CheckBox
                {
                    ClassId = $"Addon_{addon.Id}"
                };
                
                var addonLabel = new Label
                {
                    Text = $"{addon.Name}    +Â£{addon.Price:F2}",
                    FontSize = 14,
                    TextColor = Color.FromArgb("#1E293B"),
                    VerticalOptions = LayoutOptions.Center
                };
                
                checkBox.CheckedChanged += (s, e) => UpdateModifierTotal();
                
                var grid = new Grid
                {
                    ColumnDefinitions =
                    {
                        new ColumnDefinition { Width = GridLength.Auto },
                        new ColumnDefinition { Width = GridLength.Star }
                    },
                    ColumnSpacing = 10
                };
                
                Grid.SetColumn(checkBox, 0);
                Grid.SetColumn(addonLabel, 1);
                grid.Children.Add(checkBox);
                grid.Children.Add(addonLabel);
                
                section.Children.Add(grid);
            }
            
            return section;
        }
        
        private VerticalStackLayout CreateNotesSection()
        {
            var section = new VerticalStackLayout { Spacing = 10 };
            
            var label = new Label
            {
                Text = "Special Notes:",
                FontSize = 14,
                FontAttributes = FontAttributes.Bold,
                TextColor = Color.FromArgb("#64748B")
            };
            section.Children.Add(label);
            
            var entry = new Entry
            {
                Placeholder = "e.g., Well done, No onions...",
                PlaceholderColor = Color.FromArgb("#94A3B8"),
                BackgroundColor = Color.FromArgb("#F8FAFC"),
                TextColor = Color.FromArgb("#1E293B"),
                ClassId = "NotesEntry"
            };
            section.Children.Add(entry);
            
            return section;
        }
        
        private void OnQuantityChanged(object? sender, EventArgs e)
        {
            if (sender is Button button)
            {
                var quantityLabel = ModifierContent.Children
                    .OfType<VerticalStackLayout>()
                    .FirstOrDefault()?
                    .Children.OfType<Grid>()
                    .FirstOrDefault()?
                    .Children.OfType<Label>()
                    .FirstOrDefault(l => l.ClassId == "QuantityLabel");
                
                if (quantityLabel != null)
                {
                    int currentQty = int.Parse(quantityLabel.Text);
                    
                    if (button.ClassId == "QuantityPlus")
                        currentQty++;
                    else if (button.ClassId == "QuantityMinus" && currentQty > 1)
                        currentQty--;
                    
                    quantityLabel.Text = currentQty.ToString();
                    UpdateModifierTotal();
                }
            }
        }
        
        private void UpdateModifierTotal()
        {
            if (_modifierPopupItem == null) return;
            
            decimal basePrice = _modifierPopupItem.Price;
            int quantity = GetModifierQuantity();
            decimal addonsTotal = GetSelectedAddonsTotal();
            
            decimal itemTotal = (basePrice + addonsTotal) * quantity;
            ModifierTotalLabel.Text = $"Â£{itemTotal:F2}";
        }
        
        private int GetModifierQuantity()
        {
            var quantityLabel = ModifierContent.Children
                .OfType<VerticalStackLayout>()
                .FirstOrDefault()?
                .Children.OfType<Grid>()
                .FirstOrDefault()?
                .Children.OfType<Label>()
                .FirstOrDefault(l => l.ClassId == "QuantityLabel");
            
            return quantityLabel != null ? int.Parse(quantityLabel.Text) : 1;
        }
        
        private decimal GetSelectedAddonsTotal()
        {
            if (_modifierPopupItem == null || !_modifierPopupItem.HasAddons) return 0;
            
            decimal total = 0;
            foreach (var child in ModifierContent.Children.OfType<VerticalStackLayout>())
            {
                foreach (var grid in child.Children.OfType<Grid>())
                {
                    var checkBox = grid.Children.OfType<CheckBox>().FirstOrDefault();
                    if (checkBox != null && checkBox.IsChecked && checkBox.ClassId?.StartsWith("Addon_") == true)
                    {
                        var addonId = checkBox.ClassId.Replace("Addon_", "");
                        var addon = _modifierPopupItem.Addons.FirstOrDefault(a => a.Id == addonId);
                        if (addon != null)
                            total += addon.Price;
                    }
                }
            }
            return total;
        }
        
        private List<SelectedAddon> GetSelectedAddons()
        {
            var selected = new List<SelectedAddon>();
            
            if (_modifierPopupItem == null || !_modifierPopupItem.HasAddons) return selected;
            
            foreach (var child in ModifierContent.Children.OfType<VerticalStackLayout>())
            {
                foreach (var grid in child.Children.OfType<Grid>())
                {
                    var checkBox = grid.Children.OfType<CheckBox>().FirstOrDefault();
                    if (checkBox != null && checkBox.IsChecked && checkBox.ClassId?.StartsWith("Addon_") == true)
                    {
                        var addonId = checkBox.ClassId.Replace("Addon_", "");
                        var addon = _modifierPopupItem.Addons.FirstOrDefault(a => a.Id == addonId);
                        if (addon != null)
                        {
                            selected.Add(new SelectedAddon
                            {
                                Id = addon.Id,
                                Name = addon.Name,
                                Price = addon.Price
                            });
                        }
                    }
                }
            }
            return selected;
        }
        
        private string? GetNotes()
        {
            var notesEntry = ModifierContent.Children
                .OfType<VerticalStackLayout>()
                .LastOrDefault()?
                .Children.OfType<Entry>()
                .FirstOrDefault(e => e.ClassId == "NotesEntry");
            
            return notesEntry?.Text;
        }
        
        private void OnAddToOrderClicked(object sender, EventArgs e)
        {
            if (_modifierPopupItem == null) return;
            
            int quantity = GetModifierQuantity();
            var addons = GetSelectedAddons();
            string? notes = GetNotes();
            
            AddItemToOrder(_modifierPopupItem, quantity, addons, notes);
            
            ModifierPopupOverlay.IsVisible = false;
        }
        
        private void AddItemToOrder(FoodMenuItem item, int quantity, List<SelectedAddon>? addons, string? notes)
        {
            var orderItem = new TableOrderItem
            {
                Id = Guid.NewGuid().ToString(),
                OrderId = _currentOrder.Id,
                MenuItemId = item.Id,
                CategoryId = item.CategoryId,
                CategoryColor = _selectedCategory?.Color ?? "#3B82F6",
                Name = item.Name,
                UnitPrice = item.Price,
                Quantity = quantity,
                Notes = notes,
                CreatedAt = DateTime.Now,
                SendStatus = ItemSendStatus.NotSent
            };
            
            if (addons != null && addons.Any())
            {
                foreach (var addon in addons)
                {
                    orderItem.SelectedAddons.Add(addon);
                }
            }
            
            _currentOrder.Items.Add(orderItem);
            _currentOrder.RecalculateAll();
            
            UpdateDisplay();
            RefreshOrderItemsList();
        }
        
        private void RefreshOrderItemsList()
        {
            OrderItemsContainer.Children.Clear();
            
            foreach (var item in _currentOrder.Items.Where(i => !i.IsVoided))
            {
                var itemView = CreateOrderItemView(item);
                OrderItemsContainer.Children.Add(itemView);
            }
        }
        
        private View CreateOrderItemView(TableOrderItem item)
        {
            var border = new Border
            {
                BackgroundColor = Colors.White,
                Stroke = Color.FromArgb("#E2E8F0"),
                StrokeThickness = 1,
                Padding = new Thickness(12),
                Margin = new Thickness(0, 0, 0, 10),
                StrokeShape = new RoundRectangle { CornerRadius = 8 }
            };
            
            var mainGrid = new Grid
            {
                ColumnDefinitions =
                {
                    new ColumnDefinition { Width = new GridLength(4) },
                    new ColumnDefinition { Width = GridLength.Star },
                    new ColumnDefinition { Width = GridLength.Auto }
                },
                RowDefinitions =
                {
                    new RowDefinition { Height = GridLength.Auto },
                    new RowDefinition { Height = GridLength.Auto },
                    new RowDefinition { Height = GridLength.Auto }
                },
                ColumnSpacing = 10,
                RowSpacing = 5
            };
            
            // Color strip
            var colorStrip = new BoxView
            {
                BackgroundColor = Color.FromArgb(item.CategoryColor),
                WidthRequest = 4
            };
            Grid.SetColumn(colorStrip, 0);
            Grid.SetRowSpan(colorStrip, 3);
            mainGrid.Children.Add(colorStrip);
            
            // Item name
            var nameLabel = new Label
            {
                Text = item.Name,
                FontSize = 14,
                FontAttributes = FontAttributes.Bold,
                TextColor = Color.FromArgb("#1E293B")
            };
            Grid.SetColumn(nameLabel, 1);
            Grid.SetRow(nameLabel, 0);
            mainGrid.Children.Add(nameLabel);
            
            // Price
            var priceLabel = new Label
            {
                Text = $"Â£{item.TotalPrice:F2}",
                FontSize = 14,
                FontAttributes = FontAttributes.Bold,
                TextColor = Color.FromArgb("#10B981"),
                VerticalOptions = LayoutOptions.Center
            };
            Grid.SetColumn(priceLabel, 2);
            Grid.SetRow(priceLabel, 0);
            mainGrid.Children.Add(priceLabel);
            
            // Modifiers/Addons (if any)
            if (item.HasModifiers || item.SelectedAddons.Any())
            {
                var modifiersLabel = new Label
                {
                    Text = item.ModifiersDisplay,
                    FontSize = 11,
                    TextColor = Color.FromArgb("#64748B"),
                    LineBreakMode = LineBreakMode.WordWrap
                };
                Grid.SetColumn(modifiersLabel, 1);
                Grid.SetRow(modifiersLabel, 1);
                Grid.SetColumnSpan(modifiersLabel, 2);
                mainGrid.Children.Add(modifiersLabel);
            }
            
            // Notes (if any)
            if (item.HasNotes)
            {
                var notesLabel = new Label
                {
                    Text = $"ðŸ“ {item.Notes}",
                    FontSize = 11,
                    TextColor = Color.FromArgb("#F59E0B"),
                    FontAttributes = FontAttributes.Italic,
                    LineBreakMode = LineBreakMode.WordWrap
                };
                Grid.SetColumn(notesLabel, 1);
                Grid.SetRow(notesLabel, 2);
                Grid.SetColumnSpan(notesLabel, 2);
                mainGrid.Children.Add(notesLabel);
            }
            
            // Quantity controls
            var controlsGrid = new Grid
            {
                ColumnDefinitions =
                {
                    new ColumnDefinition { Width = new GridLength(35) },
                    new ColumnDefinition { Width = new GridLength(40) },
                    new ColumnDefinition { Width = new GridLength(35) },
                    new ColumnDefinition { Width = new GridLength(10) },
                    new ColumnDefinition { Width = new GridLength(40) }
                },
                ColumnSpacing = 5,
                Margin = new Thickness(0, 8, 0, 0)
            };
            
            var minusBtn = new Button
            {
                Text = "âˆ’",
                BackgroundColor = Color.FromArgb("#EF4444"),
                TextColor = Colors.White,
                FontSize = 16,
                CornerRadius = 6,
                Padding = new Thickness(0),
                HeightRequest = 32
            };
            minusBtn.Clicked += (s, e) => OnDecreaseQuantity(item);
            Grid.SetColumn(minusBtn, 0);
            controlsGrid.Children.Add(minusBtn);
            
            var qtyLabel = new Label
            {
                Text = item.Quantity.ToString(),
                FontSize = 16,
                FontAttributes = FontAttributes.Bold,
                TextColor = Color.FromArgb("#1E293B"),
                HorizontalTextAlignment = TextAlignment.Center,
                VerticalTextAlignment = TextAlignment.Center
            };
            Grid.SetColumn(qtyLabel, 1);
            controlsGrid.Children.Add(qtyLabel);
            
            var plusBtn = new Button
            {
                Text = "+",
                BackgroundColor = Color.FromArgb("#10B981"),
                TextColor = Colors.White,
                FontSize = 16,
                CornerRadius = 6,
                Padding = new Thickness(0),
                HeightRequest = 32
            };
            plusBtn.Clicked += (s, e) => OnIncreaseQuantity(item);
            Grid.SetColumn(plusBtn, 2);
            controlsGrid.Children.Add(plusBtn);
            
            var noteBtn = new Button
            {
                Text = "ðŸ“",
                BackgroundColor = Color.FromArgb("#F59E0B"),
                TextColor = Colors.White,
                FontSize = 14,
                CornerRadius = 6,
                Padding = new Thickness(0),
                HeightRequest = 32
            };
            noteBtn.Clicked += (s, e) => OnEditItemNote(item);
            Grid.SetColumn(noteBtn, 4);
            controlsGrid.Children.Add(noteBtn);
            
            Grid.SetColumn(controlsGrid, 1);
            Grid.SetRow(controlsGrid, item.HasNotes ? 3 : (item.HasModifiers || item.SelectedAddons.Any() ? 2 : 1));
            Grid.SetColumnSpan(controlsGrid, 2);
            mainGrid.Children.Add(controlsGrid);
            
            border.Content = mainGrid;
            
            // Add swipe to delete
            var swipeView = new SwipeView
            {
                Content = border
            };
            
            var deleteItem = new SwipeItem
            {
                Text = "Delete",
                BackgroundColor = Color.FromArgb("#EF4444"),
                IconImageSource = "delete.png"
            };
            deleteItem.Invoked += async (s, e) => await OnDeleteItem(item);
            
            swipeView.LeftItems = new SwipeItems { deleteItem };
            
            return swipeView;
        }
        
        private void OnIncreaseQuantity(TableOrderItem item)
        {
            item.Quantity++;
            _currentOrder.RecalculateAll();
            UpdateDisplay();
            RefreshOrderItemsList();
        }
        
        private void OnDecreaseQuantity(TableOrderItem item)
        {
            if (item.Quantity > 1)
            {
                item.Quantity--;
                _currentOrder.RecalculateAll();
                UpdateDisplay();
                RefreshOrderItemsList();
            }
        }
        
        private async Task OnDeleteItem(TableOrderItem item)
        {
            // Show void reason dialog
            string reason = await DisplayActionSheet("Void Reason", "Cancel", null,
                "Customer changed mind",
                "Wrong item entered",
                "Kitchen error",
                "Manager override");
            
            if (reason != null && reason != "Cancel")
            {
                item.IsVoided = true;
                item.VoidReason = reason;
                _currentOrder.RecalculateAll();
                UpdateDisplay();
                RefreshOrderItemsList();
            }
        }
        
        private async void OnEditItemNote(TableOrderItem item)
        {
            string result = await DisplayPromptAsync("Item Note", "Enter special instructions:", initialValue: item.Notes ?? "", maxLength: 200);
            if (result != null)
            {
                item.Notes = result;
                RefreshOrderItemsList();
            }
        }
        
        private void UpdateDisplay()
        {
            TableNumberLabel.Text = $"TABLE {_currentOrder.TableNumber}";
            StaffNameLabel.Text = $"Staff: {_currentOrder.StaffName}";
            CoverCountLabel.Text = $"Cover: {_currentOrder.CoverCount}";
            
            SubtotalLabel.Text = $"Â£{_currentOrder.Subtotal:F2}";
            
            if (_currentOrder.ServiceCharge > 0)
            {
                ServiceChargeRow.IsVisible = true;
                ServiceChargePercentLabel.Text = $"Service Charge ({_currentOrder.ServiceChargePercent}%):";
                ServiceChargeLabel.Text = $"Â£{_currentOrder.ServiceCharge:F2}";
            }
            else
            {
                ServiceChargeRow.IsVisible = false;
            }
            
            TotalLabel.Text = $"Â£{_currentOrder.Total:F2}";
        }
        
        // Button Handlers
        private async void OnChangeTableClicked(object sender, EventArgs e)
        {
            string result = await DisplayPromptAsync("Change Table", "Enter table number:", keyboard: Keyboard.Numeric);
            if (int.TryParse(result, out int tableNum))
            {
                _currentOrder.TableNumber = tableNum;
                UpdateDisplay();
            }
        }
        
        private async void OnServiceFeeClicked(object sender, EventArgs e)
        {
            string result = await DisplayActionSheet("Service Charge", "Cancel", null, "No Service Charge", "10%", "12.5%", "15%");
            
            if (result != null && result != "Cancel")
            {
                if (result == "No Service Charge")
                    _currentOrder.ServiceChargePercent = 0;
                else
                    _currentOrder.ServiceChargePercent = decimal.Parse(result.Replace("%", ""));
                
                _currentOrder.RecalculateAll();
                UpdateDisplay();
            }
        }
        
        private async void OnNotesClicked(object sender, EventArgs e)
        {
            string result = await DisplayPromptAsync("Order Notes", "Enter notes for this order:", initialValue: _currentOrder.Notes ?? "", maxLength: 500);
            if (result != null)
            {
                _currentOrder.Notes = result;
            }
        }
        
        private async void OnVoidClicked(object sender, EventArgs e)
        {
            bool confirm = await DisplayAlert("Void Order", $"Are you sure you want to void this entire order (Â£{_currentOrder.Total:F2})?", "Yes", "No");
            if (!confirm) return;
            
            string reason = await DisplayActionSheet("Void Reason", "Cancel", null,
                "Customer changed mind",
                "Wrong item entered",
                "Kitchen error",
                "Manager override");
            
            if (reason != null && reason != "Cancel")
            {
                // Check if PIN required
                if (_currentOrder.Total > 30 && (_currentUser == null || _currentUser.Role == UserRole.User))
                {
                    string pin = await DisplayPromptAsync("Manager Authorization", "Enter Manager PIN:", keyboard: Keyboard.Numeric);
                    // TODO: Verify PIN
                }
                
                _currentOrder.Status = TableOrderStatus.Voided;
                await DisplayAlert("Success", "Order voided successfully", "OK");
                await Navigation.PopAsync();
            }
        }
        
        private async void OnMoreClicked(object sender, EventArgs e)
        {
            string action = await DisplayActionSheet("More Options", "Cancel", null,
                "Discount",
                "Table Transfer",
                "Merge Tables",
                "Fire Course",
                "Loyalty Points",
                "Split Bill",
                "Price Override",
                "Cash Drawer");
            
            if (action == "Discount")
                await ShowDiscountDialog();
            else if (action == "Fire Course")
                await ShowFireCourseDialog();
            // TODO: Implement other actions
        }
        
        private async Task ShowDiscountDialog()
        {
            string type = await DisplayActionSheet("Discount Type", "Cancel", null, "Fixed Amount (Â£)", "Percentage (%)");
            if (type == null || type == "Cancel") return;
            
            string amountStr = await DisplayPromptAsync("Discount", $"Enter discount {(type.Contains("Fixed") ? "amount" : "percentage")}:", keyboard: Keyboard.Numeric);
            if (string.IsNullOrEmpty(amountStr)) return;
            
            if (!decimal.TryParse(amountStr, out decimal amount)) return;
            
            string reason = await DisplayActionSheet("Discount Reason", "Cancel", null,
                "Staff",
                "Family/Friend",
                "Good Will",
                "3rd Party Voucher",
                "Other");
            
            if (reason == null || reason == "Cancel") return;
            
            if (reason == "Other")
            {
                reason = await DisplayPromptAsync("Discount Reason", "Enter custom reason:");
            }
            
            // Check if PIN required
            if (amount > 30 && (_currentUser == null || _currentUser.Role == UserRole.User))
            {
                string pin = await DisplayPromptAsync("Manager Authorization", "Enter Manager PIN:", keyboard: Keyboard.Numeric);
                // TODO: Verify PIN
            }
            
            if (type.Contains("Fixed"))
            {
                _currentOrder.Discount = amount;
            }
            else
            {
                _currentOrder.DiscountPercent = amount;
                _currentOrder.Discount = Math.Round(_currentOrder.Subtotal * (amount / 100), 2);
            }
            
            _currentOrder.DiscountReason = reason;
            _currentOrder.RecalculateAll();
            UpdateDisplay();
        }
        
        private async Task ShowFireCourseDialog()
        {
            string course = await DisplayActionSheet("Fire Course", "Cancel", null,
                "Send Starters",
                "Send Mains",
                "Send Desserts",
                "Send All Together");
            
            if (course != null && course != "Cancel")
            {
                // TODO: Implement course sending logic
                await DisplayAlert("Success", $"{course} sent to kitchen", "OK");
            }
        }
        
        private async void OnSendClicked(object sender, EventArgs e)
        {
            if (!_currentOrder.Items.Any(i => !i.IsVoided))
            {
                await DisplayAlert("Error", "No items to send", "OK");
                return;
            }
            
            // Mark all items as sent
            foreach (var item in _currentOrder.Items.Where(i => !i.IsVoided && i.SendStatus == ItemSendStatus.NotSent))
            {
                item.SendStatus = ItemSendStatus.Sent;
                item.SentAt = DateTime.Now;
            }
            
            _currentOrder.Status = TableOrderStatus.Sent;
            
            await DisplayAlert("Success", "Order sent to kitchen", "OK");
        }
        
        private async void OnPayClicked(object sender, EventArgs e)
        {
            if (!_currentOrder.Items.Any(i => !i.IsVoided))
            {
                await DisplayAlert("Error", "No items in order", "OK");
                return;
            }
            
            // TODO: Navigate to payment page
            await DisplayAlert("Payment", $"Total to pay: Â£{_currentOrder.Total:F2}", "OK");
        }
        
        // Search functionality
        private void OnSearchTextChanged(object sender, TextChangedEventArgs e)
        {
            if (string.IsNullOrWhiteSpace(e.NewTextValue))
            {
                ClearSearchButton.IsVisible = false;
                
                // Restore category view
                if (_selectedSubCategory != null)
                    LoadItemsForCategory(_selectedSubCategory.Id);
                else if (_selectedCategory != null)
                    LoadItemsForCategory(_selectedCategory.Id);
            }
            else
            {
                ClearSearchButton.IsVisible = true;
                SearchItems(e.NewTextValue);
            }
        }
        
        private void OnClearSearchClicked(object sender, EventArgs e)
        {
            SearchEntry.Text = string.Empty;
        }
        
        private void SearchItems(string searchTerm)
        {
            var lowerSearch = searchTerm.ToLower();
            _filteredItems = _allMenuItems
                .Where(i => i.Name.ToLower().Contains(lowerSearch) || 
                           (i.Description?.ToLower().Contains(lowerSearch) ?? false))
                .OrderBy(i => i.DisplayOrder)
                .ToList();
            
            BuildItemGrid();
        }
        
        // Popup handlers
        private void OnCloseModifierPopup(object sender, EventArgs e)
        {
            ModifierPopupOverlay.IsVisible = false;
        }
        
        private void OnPopupContentTapped(object sender, EventArgs e)
        {
            // Prevent closing when tapping inside popup
        }
        
        // Helper method to lighten color
        private string LightenColor(string hexColor)
        {
            try
            {
                var color = Color.FromArgb(hexColor);
                return Color.FromRgba(
                    color.Red + (1 - color.Red) * 0.5,
                    color.Green + (1 - color.Green) * 0.5,
                    color.Blue + (1 - color.Blue) * 0.5,
                    color.Alpha
                ).ToHex();
            }
            catch
            {
                return "#E0E7FF";
            }
        }
    }
}
