<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="POS_in_NET.Pages.OrderManagementPage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:views="clr-namespace:POS_in_NET.Views"
             xmlns:dataGrid="clr-namespace:Syncfusion.Maui.DataGrid;assembly=Syncfusion.Maui.DataGrid"
             Title=""
             BackgroundColor="{StaticResource Background}">

    <Grid RowDefinitions="Auto,*">
        
        <!-- Top Bar -->
        <views:TopBar x:Name="TopBar" Grid.Row="0"/>
        
        <!-- Main Content -->
        <Grid Grid.Row="1" RowDefinitions="Auto,*,Auto" Padding="24">
        
        <!-- Modern Header -->
        <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Margin="0,0,0,20">
            
            <!-- Left Side: Title & Sync Info -->
            <VerticalStackLayout Grid.Column="0" Spacing="8">
                <Label Text="Live Orders" 
                       Style="{StaticResource HeadlineLarge}" />
                <HorizontalStackLayout Spacing="12">
                    <Label Text="ðŸ”„" FontSize="14" />
                    <Label x:Name="LastSyncLabel" 
                           Text="Last sync: --:--" 
                           Style="{StaticResource BodyMedium}"
                           TextColor="{StaticResource TextSecondary}" />
                </HorizontalStackLayout>
            </VerticalStackLayout>
            
            <!-- Right Side: Filter & Refresh -->
            <HorizontalStackLayout Grid.Column="1" Spacing="16" VerticalOptions="Center">
                <Frame BackgroundColor="{StaticResource SurfaceVariant}" 
                       Padding="12,8" 
                       CornerRadius="12"
                       HasShadow="False">
                    <HorizontalStackLayout Spacing="10">
                        <Label Text="Filter:" 
                               Style="{StaticResource LabelMedium}"
                               VerticalOptions="Center" />
                        <Picker x:Name="StatusFilterPicker" 
                                Title="All Orders"
                                SelectedIndexChanged="OnStatusFilterChanged"
                                BackgroundColor="Transparent"
                                TextColor="{StaticResource TextPrimary}"
                                WidthRequest="150">
                            <Picker.Items>
                                <x:String>All Orders</x:String>
                                <x:String>New Orders</x:String>
                                <x:String>In Kitchen</x:String>
                                <x:String>Preparing</x:String>
                                <x:String>Ready</x:String>
                                <x:String>Delivering</x:String>
                                <x:String>Completed</x:String>
                            </Picker.Items>
                        </Picker>
                    </HorizontalStackLayout>
                </Frame>
                
                <Button x:Name="RefreshButton" 
                        Text="ðŸ”„ Refresh" 
                        Style="{StaticResource PrimaryButton}"
                        Clicked="OnRefreshClicked"
                        HeightRequest="48" />
            </HorizontalStackLayout>
        </Grid>

        <!-- Modern Orders Grid -->
        <Frame Grid.Row="1" Style="{StaticResource ModernCard}" Padding="0">
            <CollectionView x:Name="OrdersCollectionView" 
                            ItemsSource="{Binding Orders}"
                            BackgroundColor="Transparent"
                            Margin="16">
                
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame Margin="0,0,0,12" 
                               BackgroundColor="{StaticResource Surface}" 
                               Padding="20"
                               CornerRadius="16"
                               HasShadow="False"
                               BorderColor="{StaticResource Outline}">
                            <Grid RowDefinitions="Auto,Auto,Auto,Auto" 
                                  ColumnDefinitions="*,Auto,Auto" 
                                  RowSpacing="12">

                                <!-- Order Header -->
                                <HorizontalStackLayout Grid.Row="0" Grid.Column="0" Spacing="12">
                                    <Label Text="ðŸ“¦" FontSize="20" VerticalOptions="Center" />
                                    <Label Text="{Binding OrderId}" 
                                           Style="{StaticResource TitleMedium}"
                                           TextColor="{StaticResource Primary}"
                                           VerticalOptions="Center" />
                                    <Label Text="â€¢" 
                                           TextColor="{StaticResource TextTertiary}"
                                           VerticalOptions="Center" />
                                    <Label Text="{Binding CustomerName}" 
                                           Style="{StaticResource BodyLarge}"
                                           VerticalOptions="Center" />
                                </HorizontalStackLayout>

                                <!-- Status Badge -->
                                <Frame Grid.Row="0" Grid.Column="1" 
                                       BackgroundColor="{Binding StatusColor}" 
                                       Padding="12,6" 
                                       CornerRadius="16" 
                                       HasShadow="False"
                                       Margin="0,0,12,0">
                                    <Label Text="{Binding Status}" 
                                           TextColor="White" 
                                           Style="{StaticResource LabelMedium}"
                                           FontAttributes="Bold" />
                                </Frame>

                                <!-- Time Display -->
                                <HorizontalStackLayout Grid.Row="0" Grid.Column="2" Spacing="6" VerticalOptions="Center">
                                    <Label Text="ðŸ•" FontSize="14" />
                                    <Label Text="{Binding TimeDisplay}" 
                                           Style="{StaticResource BodySmall}"
                                           TextColor="{StaticResource TextSecondary}" />
                                </HorizontalStackLayout>

                                <!-- Customer Info -->
                                <VerticalStackLayout Grid.Row="1" Grid.ColumnSpan="3" Spacing="6">
                                    <HorizontalStackLayout Spacing="8">
                                        <Label Text="ðŸ“ž" FontSize="14" />
                                        <Label Text="{Binding CustomerPhone}" 
                                               Style="{StaticResource BodyMedium}"
                                               TextColor="{StaticResource TextSecondary}" />
                                    </HorizontalStackLayout>
                                    <HorizontalStackLayout Spacing="8">
                                        <Label Text="ðŸ“" FontSize="14" />
                                        <Label Text="{Binding CustomerAddress}" 
                                               Style="{StaticResource BodyMedium}"
                                               TextColor="{StaticResource TextSecondary}"
                                               LineBreakMode="TailTruncation" />
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>

                                <!-- Order Items -->
                                <Frame Grid.Row="2" Grid.ColumnSpan="3" 
                                       BackgroundColor="{StaticResource SurfaceVariant}"
                                       Padding="12"
                                       CornerRadius="12"
                                       HasShadow="False">
                                    <CollectionView ItemsSource="{Binding Items}"
                                                    BackgroundColor="Transparent">
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate>
                                                <Grid ColumnDefinitions="*,Auto,Auto" 
                                                      Padding="8"
                                                      Margin="0,2">
                                                    <Label Grid.Column="0" 
                                                           Text="{Binding ItemName}" 
                                                           Style="{StaticResource BodyMedium}"
                                                           VerticalOptions="Center" />
                                                    <Label Grid.Column="1" 
                                                           Text="{Binding Quantity, StringFormat='x{0}'}" 
                                                           Style="{StaticResource BodyMedium}"
                                                           TextColor="{StaticResource TextSecondary}"
                                                           VerticalOptions="Center"
                                                           Margin="10,0" />
                                                    <Label Grid.Column="2" 
                                                           Text="{Binding Price, StringFormat='Â£{0:F2}'}" 
                                                           Style="{StaticResource LabelLarge}"
                                                           FontAttributes="Bold"
                                                           TextColor="{StaticResource Primary}"
                                                           VerticalOptions="Center" />
                                                </Grid>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </Frame>

                                <!-- Total and Actions -->
                                <Grid Grid.Row="3" Grid.ColumnSpan="3" 
                                      ColumnDefinitions="*,Auto" 
                                      Margin="0,12,0,0">
                                    
                                    <!-- Total Amount -->
                                    <HorizontalStackLayout Grid.Column="0" Spacing="8" VerticalOptions="Center">
                                        <Label Text="ðŸ’°" FontSize="18" />
                                        <Label Text="{Binding TotalAmount, StringFormat='Total: Â£{0:F2}'}" 
                                               Style="{StaticResource TitleMedium}"
                                               TextColor="{StaticResource Primary}" />
                                    </HorizontalStackLayout>

                                    <!-- Action Buttons -->
                                    <HorizontalStackLayout Grid.Column="1" Spacing="8">
                                        
                                        <!-- Kitchen button (for New orders) -->
                                        <Button Text="ðŸ³ Kitchen" 
                                                BackgroundColor="{StaticResource Accent}"
                                                TextColor="White"
                                                FontSize="13"
                                                Padding="16,8"
                                                CornerRadius="12"
                                                IsVisible="{Binding CanSendToKitchen}"
                                                Command="{Binding Source={x:Reference OrdersCollectionView}, Path=BindingContext.SendToKitchenCommand}"
                                                CommandParameter="{Binding}" />
                                        
                                        <!-- Ready button (for Preparing orders) -->
                                        <Button Text="âœ“ Ready" 
                                                BackgroundColor="{StaticResource Secondary}"
                                                TextColor="White"
                                                FontSize="13"
                                                Padding="16,8"
                                                CornerRadius="12"
                                                IsVisible="{Binding CanMarkReady}"
                                                Command="{Binding Source={x:Reference OrdersCollectionView}, Path=BindingContext.MarkReadyCommand}"
                                                CommandParameter="{Binding}" />
                                        
                                        <!-- Delivering button (for Ready orders) -->
                                        <Button Text="ðŸš— Deliver" 
                                                BackgroundColor="{StaticResource Primary}"
                                                TextColor="White"
                                                FontSize="13"
                                                Padding="16,8"
                                                CornerRadius="12"
                                                IsVisible="{Binding CanMarkDelivering}"
                                                Command="{Binding Source={x:Reference OrdersCollectionView}, Path=BindingContext.MarkDeliveringCommand}"
                                                CommandParameter="{Binding}" />
                                        
                                        <!-- Complete button (for Delivering orders) -->
                                        <Button Text="âœ“ Complete" 
                                                BackgroundColor="#795548"
                                                TextColor="White"
                                                FontSize="13"
                                                Padding="16,8"
                                                CornerRadius="12"
                                                IsVisible="{Binding CanComplete}"
                                                Command="{Binding Source={x:Reference OrdersCollectionView}, Path=BindingContext.CompleteOrderCommand}"
                                                CommandParameter="{Binding}" />

                                    </HorizontalStackLayout>
                                </Grid>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
                
                <!-- Modern Empty State -->
                <CollectionView.EmptyView>
                    <VerticalStackLayout Padding="60" VerticalOptions="Center" Spacing="16">
                        <Label Text="ðŸ“‹" 
                               FontSize="64" 
                               HorizontalOptions="Center"
                               Opacity="0.5" />
                        <Label Text="No orders found" 
                               Style="{StaticResource HeadlineMedium}"
                               HorizontalOptions="Center" />
                        <Label Text="Orders from your online system will appear here" 
                               Style="{StaticResource BodyLarge}"
                               TextColor="{StaticResource TextSecondary}"
                               HorizontalOptions="Center"
                               HorizontalTextAlignment="Center" />
                    </VerticalStackLayout>
                </CollectionView.EmptyView>
                
            </CollectionView>
        </Frame>

        <!-- Modern Footer Actions -->
        <Grid Grid.Row="2" ColumnDefinitions="*,Auto,Auto" ColumnSpacing="16" Margin="0,20,0,0">
            
            <HorizontalStackLayout Grid.Column="0" Spacing="12" VerticalOptions="Center">
                <Label Text="ðŸŒ" FontSize="18" />
                <Label x:Name="ConnectionStatusLabel" 
                       Text="API Status: Checking..." 
                       Style="{StaticResource BodyMedium}"
                       TextColor="{StaticResource TextSecondary}" />
            </HorizontalStackLayout>
            
            <Button Grid.Column="1"
                    Text="âš™ï¸ API Settings" 
                    Style="{StaticResource SecondaryButton}"
                    Clicked="OnApiSettingsClicked"
                    HeightRequest="48" />
            
            <Button Grid.Column="2"
                    Text="ðŸ”Œ Test Connection" 
                    Style="{StaticResource OutlineButton}"
                    Clicked="OnTestConnectionClicked"
                    HeightRequest="48" />
        </Grid>

        </Grid>
    </Grid>

</ContentPage>